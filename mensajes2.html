<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Mensajes en Tiempo Real</title>
    <!-- Materialize CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <!-- Google Icon Font (necesario para algunos componentes de Materialize) -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* Define la fuente Inter (Materialize ya usa Roboto, pero podemos mantener Inter si se prefiere) */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to bottom right, #e0f2f7, #e1bee7); /* Degradado similar al anterior */
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px 0; /* Añadir padding vertical para espaciar */
        }

        /* Estilos para el contenedor principal */
        .main-container {
            background-color: #ffffff;
            padding: 40px;
            border-radius: 15px; /* Bordes más redondeados */
            box-shadow: 0 8px 17px 2px rgba(0, 0, 0, 0.14), 0 3px 14px 2px rgba(0, 0, 0, 0.12), 0 5px 5px -3px rgba(0, 0, 0, 0.2); /* Sombra más pronunciada */
            width: 100%;
            max-width: 800px; /* Ajustado para un mejor aspecto general, similar a lg:max-w-3xl */
        }

        /* Estilos para el contenedor de mensajes deslizables */
        #messages-container {
            display: flex; /* Usa flexbox para mostrar los elementos en una fila */
            overflow-x: auto; /* Permite el desplazamiento horizontal si el contenido excede el ancho */
            gap: 1rem; /* Espacio entre los mensajes */
            padding-bottom: 0.5rem; /* Pequeño padding para la barra de desplazamiento */
            padding-left: 1rem; /* Padding horizontal */
            padding-right: 1rem; /* Padding horizontal */
            -webkit-overflow-scrolling: touch; /* Mejora el desplazamiento en dispositivos iOS */
            scrollbar-width: thin; /* Para Firefox */
            scrollbar-color: #9ca3af #e5e7eb; /* Para Firefox */
        }

        /* Estilos para la barra de desplazamiento en navegadores WebKit (Chrome, Safari) */
        #messages-container::-webkit-scrollbar {
            height: 8px; /* Altura de la barra de desplazamiento horizontal */
        }

        #messages-container::-webkit-scrollbar-track {
            background: #e5e7eb; /* Color del fondo de la barra de desplazamiento */
            border-radius: 10px;
        }

        #messages-container::-webkit-scrollbar-thumb {
            background-color: #9ca3af; /* Color del "pulgar" de la barra de desplazamiento */
            border-radius: 10px;
            border: 2px solid #e5e7eb; /* Borde alrededor del pulgar */
        }

        /* Estilos para cada mensaje individual dentro del contenedor deslizable */
        .message-card {
            flex-shrink: 0; /* Evita que los mensajes se encojan */
            min-width: 280px; /* Ancho mínimo ajustado para cada tarjeta de mensaje */
            max-width: 320px; /* Ancho máximo ajustado para cada tarjeta de mensaje */
            box-sizing: border-box; /* Incluye padding y borde en el ancho total */
            white-space: normal; /* Asegura que el texto dentro de la tarjeta se envuelva */
            margin-bottom: 10px; /* Espacio inferior para evitar que se peguen */
        }

        /* Ajustes para los campos de entrada de Materialize */
        .input-field label {
            color: #424242; /* Color de la etiqueta */
        }
        .input-field input[type=text]:focus + label,
        .input-field textarea.materialize-textarea:focus + label {
            color: #2196f3; /* Color de la etiqueta al enfocar */
        }
        .input-field input[type=text]:focus,
        .input-field textarea.materialize-textarea:focus {
            border-bottom: 1px solid #2196f3; /* Borde inferior al enfocar */
            box-shadow: 0 1px 0 0 #2196f3; /* Sombra al enfocar */
        }
    </style>
</head>
<body>
    <div class="main-container z-depth-2">
        <h1 class="center-align" style="font-size: 2.5rem; font-weight: 900; color: #333;">
            Envía tu Mensaje
        </h1>

        <!-- Formulario para enviar mensajes -->
        <form id="message-form">
            <div class="row">
                <div class="input-field col s12">
                    <input id="name-input" type="text" class="validate" required>
                    <label for="name-input">Tu Nombre</label>
                </div>
            </div>
            <div class="row">
                <div class="input-field col s12">
                    <textarea id="message-input" class="materialize-textarea" required></textarea>
                    <label for="message-input">Tu Mensaje</label>
                </div>
            </div>
            <div class="row center-align">
                <button class="btn waves-effect waves-light blue darken-1" type="submit" name="action">
                    Enviar Mensaje
                    <i class="material-icons right">send</i>
                </button>
            </div>
        </form>

        <div class="divider" style="margin: 40px 0;"></div>

        <h2 class="center-align" style="font-size: 2rem; font-weight: 700; color: #333;">
            Mensajes Recibidos
        </h2>

        <!-- Indicador de carga -->
        <div id="loading-indicator" class="center-align grey-text text-darken-1" style="font-size: 1.1rem; padding: 20px 0;">
            Cargando mensajes...
        </div>

        <!-- Contenedor donde se mostrarán los mensajes -->
        <div id="messages-container">
            <!-- Los mensajes se cargarán aquí dinámicamente -->
        </div>
    </div>

    <!-- Materialize JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script type="module">
        // Importa las funciones necesarias de Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // Configuración de Firebase: Intenta usar __firebase_config del entorno, si no, usa la configuración por defecto.
        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "AIzaSyAIpYR5IfMLKJpogfLYMQ375PnEo9HMCYc",
                authDomain: "boda-4d986.firebaseapp.com",
                databaseURL: "https://boda-4d986-default-rtdb.firebaseio.com",
                projectId: "boda-4d986",
                storageBucket: "boda-4d986.firebasestorage.app",
                messagingSenderId: "433750913571",
                appId: "1:433750913571:web:06585ae59374f87f49f796",
                measurementId: "G-8VL86NR41N"
            };

        // Inicializa la aplicación Firebase
        const app = initializeApp(firebaseConfig);
        // Obtiene la instancia de la base de datos en tiempo real
        const db = getDatabase(app);
        // Obtiene la instancia de autenticación
        const auth = getAuth(app);

        let userId = ''; // Variable para almacenar el ID de usuario

        // Elementos del DOM
        const messageForm = document.getElementById('message-form');
        const nameInput = document.getElementById('name-input');
        const messageInput = document.getElementById('message-input');
        const messagesContainer = document.getElementById('messages-container');
        const loadingIndicator = document.getElementById('loading-indicator');

        /**
         * Función para inicializar Firebase y configurar los listeners.
         * Se ejecuta cuando la ventana ha cargado completamente.
         */
        window.onload = async () => {
            try {
                // Intenta iniciar sesión con un token personalizado si está disponible (entorno Canvas)
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    // Si no hay token, inicia sesión de forma anónima
                    await signInAnonymously(auth);
                }
                // Obtiene el ID de usuario actual o genera uno si es necesario
                userId = auth.currentUser?.uid || crypto.randomUUID();
                console.log("Firebase inicializado y autenticado. ID de usuario:", userId);

                // Configura el listener de la base de datos en tiempo real una vez autenticado
                setupRealtimeListeners();
            } catch (error) {
                console.error("Error durante la inicialización o autenticación de Firebase:", error);
                loadingIndicator.textContent = 'Error al inicializar la aplicación. Por favor, recarga la página.';
                loadingIndicator.classList.add('red-text'); // Clase de Materialize para texto rojo
            }
        };

        /**
         * Maneja el envío del formulario para guardar un nuevo mensaje en Firebase.
         */
        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault(); // Evita el envío por defecto del formulario

            const name = nameInput.value.trim();
            const message = messageInput.value.trim();

            if (name && message) {
                try {
                    // Define la referencia a la colección de mensajes en la base de datos.
                    // Se usa __app_id para crear una ruta única por aplicación, si está disponible.
                    const messagesRef = ref(db, `messages/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}`);

                    // Empuja un nuevo mensaje a la base de datos con nombre, mensaje y marca de tiempo
                    await push(messagesRef, {
                        name: name,
                        message: message,
                        timestamp: Date.now() // Guarda la marca de tiempo para ordenar
                    });

                    // Limpia los campos del formulario después de enviar
                    nameInput.value = '';
                    messageInput.value = '';
                    // Re-inicializa los campos de Materialize para que las etiquetas floten correctamente
                    M.updateTextFields();
                    M.textareaAutoResize(messageInput);
                } catch (error) {
                    console.error("Error al enviar el mensaje:", error);
                    // Muestra un mensaje de error al usuario (podrías usar un modal personalizado)
                    messagesContainer.innerHTML = `<p class="red-text">Error al enviar el mensaje: ${error.message}</p>`;
                }
            } else {
                // Informa al usuario que ambos campos son obligatorios
                messagesContainer.innerHTML = `<p class="orange-text">Por favor, escribe tu nombre y un mensaje.</p>`;
            }
        });

        /**
         * Configura el listener en tiempo real para la colección de mensajes.
         * Se activa cada vez que hay cambios en la base de datos.
         */
        function setupRealtimeListeners() {
            // Define la referencia a la colección de mensajes
            const messagesRef = ref(db, `messages/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}`);

            // onValue escucha los cambios en tiempo real
            onValue(messagesRef, (snapshot) => {
                loadingIndicator.style.display = 'none'; // Oculta el indicador de carga
                messagesContainer.innerHTML = ''; // Limpia los mensajes anteriores

                if (snapshot.exists()) {
                    const data = snapshot.val(); // Obtiene los datos del snapshot
                    const messagesArray = [];

                    // Convierte el objeto de datos en un array para facilitar la iteración y el ordenamiento
                    for (let key in data) {
                        messagesArray.push({ id: key, ...data[key] });
                    }

                    // Ordena los mensajes por marca de tiempo (los más antiguos primero)
                    messagesArray.sort((a, b) => a.timestamp - b.timestamp);

                    // Itera sobre los mensajes y los añade al contenedor
                    messagesArray.forEach((msg) => {
                        const messageElement = document.createElement('div');
                        // Aplica las clases de Materialize para una tarjeta
                        messageElement.className = 'col s12 m6 l4 message-card card blue-grey lighten-5'; // Clases de Materialize para responsividad y estilo de tarjeta
                        messageElement.innerHTML = `
                            <div class="card-content black-text">
                                <span class="card-title" style="font-weight: bold; color: #3f51b5;">${msg.name}:</span>
                                <p>${msg.message}</p>
                                <p class="right-align grey-text text-darken-1" style="font-size: 0.75rem; margin-top: 10px;">${new Date(msg.timestamp).toLocaleString()}</p>
                            </div>
                        `;
                        messagesContainer.appendChild(messageElement);
                    });
                } else {
                    // Si no hay mensajes, muestra un mensaje indicándolo
                    messagesContainer.innerHTML = '<p class="grey-text text-darken-1 center-align" style="padding: 20px 0;">No hay mensajes aún. ¡Sé el primero en escribir uno!</p>';
                }
            }, (error) => {
                // Manejo de errores al leer la base de datos
                console.error("Error al leer los mensajes:", error);
                loadingIndicator.textContent = 'Error al cargar mensajes. Por favor, verifica tu conexión.';
                loadingIndicator.classList.add('red-text');
            });
        }
    </script>
</body>
</html>
