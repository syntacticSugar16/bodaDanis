<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Mensajes en Tiempo Real</title>
    <!-- Incluye Tailwind CSS para estilos rápidos y responsivos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define la fuente Inter */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilos personalizados para el contenedor de mensajes deslizables */
        #messages-container {
            display: flex; /* Usa flexbox para mostrar los elementos en una fila */
            overflow-x: auto; /* Permite el desplazamiento horizontal si el contenido excede el ancho */
            gap: 1rem; /* Espacio entre los mensajes (equivalente a Tailwind 'gap-4') */
            padding-bottom: 0.5rem; /* Pequeño padding para la barra de desplazamiento */
            padding-left: 1rem; /* Añadido para padding horizontal */
            padding-right: 1rem; /* Añadido para padding horizontal */
            -webkit-overflow-scrolling: touch; /* Mejora el desplazamiento en dispositivos iOS */
            scrollbar-width: thin; /* Para Firefox */
            scrollbar-color: #9ca3af #e5e7eb; /* Para Firefox */
        }

        /* Estilos para la barra de desplazamiento en navegadores WebKit (Chrome, Safari) */
        #messages-container::-webkit-scrollbar {
            height: 8px; /* Altura de la barra de desplazamiento horizontal */
        }

        #messages-container::-webkit-scrollbar-track {
            background: #e5e7eb; /* Color del fondo de la barra de desplazamiento */
            border-radius: 10px;
        }

        #messages-container::-webkit-scrollbar-thumb {
            background-color: #9ca3af; /* Color del "pulgar" de la barra de desplazamiento */
            border-radius: 10px;
            border: 2px solid #e5e7eb; /* Borde alrededor del pulgar */
        }

        /* Estilos para cada mensaje individual dentro del contenedor deslizable */
        .message-card {
            flex-shrink: 0; /* Evita que los mensajes se encojan */
            min-width: 280px; /* Ancho mínimo ajustado para cada tarjeta de mensaje */
            max-width: 320px; /* Ancho máximo ajustado para cada tarjeta de mensaje */
            background-color: #ffffff;
            padding: 1rem;
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
            border: 1px solid #f3f4f6; /* border-gray-100 */
            box-sizing: border-box; /* Incluye padding y borde en el ancho total */
            white-space: normal; /* Asegura que el texto dentro de la tarjeta se envuelva */
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-100 to-purple-200 min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full bg-white p-8 rounded-xl shadow-2xl space-y-8 border border-gray-200 lg:max-w-3xl">
        <h1 class="text-4xl font-extrabold text-center text-gray-900 mb-8">
            Envía tu Mensaje
        </h1>

        <!-- Formulario para enviar mensajes -->
        <form id="message-form" class="space-y-6">
            <div>
                <label for="name-input" class="block text-sm font-medium text-gray-700 mb-1">
                    Tu Nombre
                </label>
                <input
                    type="text"
                    id="name-input"
                    class="appearance-none block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition duration-150 ease-in-out"
                    placeholder="Escribe tu nombre aquí"
                    required
                >
            </div>
            <div>
                <label for="message-input" class="block text-sm font-medium text-gray-700 mb-1">
                    Tu Mensaje
                </label>
                <textarea
                    id="message-input"
                    rows="4"
                    class="appearance-none block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition duration-150 ease-in-out resize-y"
                    placeholder="Escribe tu mensaje aquí"
                    required
                ></textarea>
            </div>
            <div>
                <button
                    type="submit"
                    class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out transform hover:scale-105"
                >
                    Enviar Mensaje
                </button>
            </div>
        </form>

        <hr class="my-8 border-t border-gray-300">

        <h2 class="text-3xl font-bold text-center text-gray-900 mb-6">
            Mensajes Recibidos
        </h2>

        <!-- Indicador de carga -->
        <div id="loading-indicator" class="text-center text-gray-600 text-lg py-4">
            Cargando mensajes...
        </div>

        <!-- Contenedor donde se mostrarán los mensajes -->
        <div id="messages-container">
            <!-- Los mensajes se cargarán aquí dinámicamente -->
        </div>
    </div>

    <script type="module">
        // Importa las funciones necesarias de Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // Configuración de Firebase: Intenta usar __firebase_config del entorno, si no, usa la configuración por defecto.
        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "AIzaSyAIpYR5IfMLKJpogfLYMQ375PnEo9HMCYc",
                authDomain: "boda-4d986.firebaseapp.com",
                databaseURL: "https://boda-4d986-default-rtdb.firebaseio.com",
                projectId: "boda-4d986",
                storageBucket: "boda-4d986.firebasestorage.app",
                messagingSenderId: "433750913571",
                appId: "1:433750913571:web:06585ae59374f87f49f796",
                measurementId: "G-8VL86NR41N"
            };

        // Inicializa la aplicación Firebase
        const app = initializeApp(firebaseConfig);
        // Obtiene la instancia de la base de datos en tiempo real
        const db = getDatabase(app);
        // Obtiene la instancia de autenticación
        const auth = getAuth(app);

        let userId = ''; // Variable para almacenar el ID de usuario

        // Elementos del DOM
        const messageForm = document.getElementById('message-form');
        const nameInput = document.getElementById('name-input');
        const messageInput = document.getElementById('message-input');
        const messagesContainer = document.getElementById('messages-container');
        const loadingIndicator = document.getElementById('loading-indicator');

        /**
         * Función para inicializar Firebase y configurar los listeners.
         * Se ejecuta cuando la ventana ha cargado completamente.
         */
        window.onload = async () => {
            try {
                // Intenta iniciar sesión con un token personalizado si está disponible (entorno Canvas)
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    // Si no hay token, inicia sesión de forma anónima
                    await signInAnonymously(auth);
                }
                // Obtiene el ID de usuario actual o genera uno si es necesario
                userId = auth.currentUser?.uid || crypto.randomUUID();
                console.log("Firebase inicializado y autenticado. ID de usuario:", userId);

                // Configura el listener de la base de datos en tiempo real una vez autenticado
                setupRealtimeListeners();
            } catch (error) {
                console.error("Error durante la inicialización o autenticación de Firebase:", error);
                loadingIndicator.textContent = 'Error al inicializar la aplicación. Por favor, recarga la página.';
                loadingIndicator.classList.add('text-red-600'); // Estilo para errores
            }
        };

        /**
         * Maneja el envío del formulario para guardar un nuevo mensaje en Firebase.
         */
        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault(); // Evita el envío por defecto del formulario

            const name = nameInput.value.trim();
            const message = messageInput.value.trim();

            if (name && message) {
                try {
                    // Define la referencia a la colección de mensajes en la base de datos.
                    // Se usa __app_id para crear una ruta única por aplicación, si está disponible.
                    const messagesRef = ref(db, `messages/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}`);

                    // Empuja un nuevo mensaje a la base de datos con nombre, mensaje y marca de tiempo
                    await push(messagesRef, {
                        name: name,
                        message: message,
                        timestamp: Date.now() // Guarda la marca de tiempo para ordenar
                    });

                    // Limpia los campos del formulario después de enviar
                    nameInput.value = '';
                    messageInput.value = '';
                } catch (error) {
                    console.error("Error al enviar el mensaje:", error);
                    // Muestra un mensaje de error al usuario (podrías usar un modal personalizado)
                    messagesContainer.innerHTML = `<p class="text-red-600">Error al enviar el mensaje: ${error.message}</p>`;
                }
            } else {
                // Informa al usuario que ambos campos son obligatorios
                messagesContainer.innerHTML = `<p class="text-orange-600">Por favor, escribe tu nombre y un mensaje.</p>`;
            }
        });

        /**
         * Configura el listener en tiempo real para la colección de mensajes.
         * Se activa cada vez que hay cambios en la base de datos.
         */
        function setupRealtimeListeners() {
            // Define la referencia a la colección de mensajes
            const messagesRef = ref(db, `messages/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}`);

            // onValue escucha los cambios en tiempo real
            onValue(messagesRef, (snapshot) => {
                loadingIndicator.style.display = 'none'; // Oculta el indicador de carga
                messagesContainer.innerHTML = ''; // Limpia los mensajes anteriores

                if (snapshot.exists()) {
                    const data = snapshot.val(); // Obtiene los datos del snapshot
                    const messagesArray = [];

                    // Convierte el objeto de datos en un array para facilitar la iteración y el ordenamiento
                    for (let key in data) {
                        messagesArray.push({ id: key, ...data[key] });
                    }

                    // Ordena los mensajes por marca de tiempo (los más antiguos primero)
                    messagesArray.sort((a, b) => a.timestamp - b.timestamp);

                    // Itera sobre los mensajes y los añade al contenedor
                    messagesArray.forEach((msg) => {
                        const messageElement = document.createElement('div');
                        // Aplica la clase CSS personalizada para las tarjetas de mensaje
                        messageElement.className = 'message-card';
                        messageElement.innerHTML = `
                            <p class="font-bold text-blue-700 text-lg">${msg.name}:</p>
                            <p class="text-gray-800 text-base mt-1">${msg.message}</p>
                            <p class="text-xs text-gray-500 mt-2">${new Date(msg.timestamp).toLocaleString()}</p>
                        `;
                        messagesContainer.appendChild(messageElement);
                    });
                } else {
                    // Si no hay mensajes, muestra un mensaje indicándolo
                    messagesContainer.innerHTML = '<p class="text-gray-600 text-center py-4">No hay mensajes aún. ¡Sé el primero en escribir uno!</p>';
                }
            }, (error) => {
                // Manejo de errores al leer la base de datos
                console.error("Error al leer los mensajes:", error);
                loadingIndicator.textContent = 'Error al cargar mensajes. Por favor, verifica tu conexión.';
                loadingIndicator.classList.add('text-red-600');
            });
        }
    </script>
</body>
</html>